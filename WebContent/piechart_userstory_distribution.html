<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
   <title>Userstory distribution</title>

    <!--App information-->
    <meta name="Name" content="User story distribution"/>
    <meta name="Version" content="0.1"/>
    <meta name="Vendor" content="Bouvet (Dagfinn Parnas)"/>

   <script type="text/javascript" src="https://rally1.rallydev.com/apps/1.29/sdk.js"></script>
   <script type="text/javascript">

     var rallyDataSource = null;
     var storyPointsPrTag= {}

     function onLoad() {
       rallyDataSource = new rally.sdk.data.RallyDataSource("9369223425",
                                  "9369223515",
                                 "false",
                                 "true");
       
       /*rallyDataSource = rally.sdk.data.RallyDataSource("__WORKSPACE_OID__",
               "__PROJECT_OID__",
               "__PROJECT_SCOPING_UP__",
               "__PROJECT_SCOPING_DOWN__");*/
               
    	createPieChart();
        
	//var iterConfig = {label : ""};
       //iterDropdown = new rally.sdk.ui.IterationDropdown(iterConfig, rallyDataSource);
      //iterDropdown.display(document.getElementById("iterationDiv"), onIterationSelected);
     }
     
     function createPieChart(){
    	 
    	 var queryObject = {
    	          	type: 'HierarchicalRequirement',
    	          	key : 'stories',
    	          	fetch: true, 
    	          	//query: '(Iteration.Name Contains "2013 01+02")'
    	          	query: '(Name Contains "Roadmap")'
    	        	};
    	 rallyDataSource.findAll(queryObject, showPieChartBasedOnResult);
     }
     
     function showPieChartBasedOnResult(results) {

    	 var NO_TAG= "User stories not tagged"
    	
    	 
    	 for ( var i = 0; i < results.stories.length; i++) {
			var userStory = results.stories[i];
			var tag=null;
			var storyPoints = 0;
			if(userStory.Tags != null && userStory.Tags.length>=1){
				tag = userStory.Tags[0]._refObjectName;
				
				
			}else {
				tag=NO_TAG;
			}
			
			storyPoints = userStory.PlanEstimate;
			if(storyPointsPrTag.hasOwnProperty(tag)){
				storyPointsPrTag[tag]=storyPointsPrTag[tag]+storyPoints;
			}else {
				storyPointsPrTag[tag]=storyPoints;
			}
			
		}
    	 
    	 
    	 var chartData={};
    	 var chartValues = {};
    	 for (var key in storyPointsPrTag) {
    		    if (storyPointsPrTag.hasOwnProperty(key)) {
    		        //alert('key is: ' + k + ', value is: ' + a[k]);
    				chartValues[key]=key;
    				chartData[key]=storyPointsPrTag[key];
    		        
    		    }
    	 }
    	 
    	 //var chartValues = {"/release/12345": "Release 1", "/release/23456": "Release 2"};
    	 //var chartData = {"/release/12345": 5, "/release/23456": 8};
    	 
         var pieConfig = {
             title : "User story distribution",
             values: chartValues,
             data:  chartData,
             height : 400,
             width : 400
           };
         var pieChart = new rally.sdk.ui.PieChart(pieConfig, rallyDataSource);
         pieChart.display("chart_distribution");
         
         //can only be called once this method is complete
         showTableDistribution ();
       }
     
     function showTableDistribution (){
    	 
         var tableConfig = {
                 columnKeys : ['Category', 'StoryPoints', 'Percentage'],
                 columnHeaders: ['Category', 'Story points', 'Percentage'],
                 columnWidths : ['300px', '80px','80px'],
               };

          table = new rally.sdk.ui.Table(tableConfig,rallyDataSource);

          var sumStoryPoints= 0; 
          for (var key in storyPointsPrTag) {
  		    if (storyPointsPrTag.hasOwnProperty(key)) {
  		    	sumStoryPoints = sumStoryPoints + storyPointsPrTag[key];   
  		    }
  	 	  }
          
          for (var key in storyPointsPrTag) {
    		    if (storyPointsPrTag.hasOwnProperty(key)) {
    		    	var storyPoints = storyPointsPrTag[key];
    		    	var percentage = ((storyPoints/sumStoryPoints)*100).toFixed(2) + ' %';
    		    	
    		    	rowInfo = {'Category' : key, 'StoryPoints' : storyPoints, 'Percentage' : percentage}; 
    		    	table.addRow(rowInfo);   
    		    }
    	 }

          table.display(document.getElementById('table_distribution'));
     }

     rally.addOnLoad(onLoad);
   </script>

</head>
<body>

   <div id="chart_distribution"></div>
   <div id="table_distribution"></div>

</body>
</html>